<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic de Paiement - Quiz de Carabin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 900px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-top: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-card {
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .status-card.success {
            border-left-color: #198754;
        }
        .status-card.warning {
            border-left-color: #ffc107;
        }
        .status-card.danger {
            border-left-color: #dc3545;
        }
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background: #2b3035;
            color: #00ff9d;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 20px;
        }
        .btn-payment {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            border: none;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-payment:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .diagnostic-result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .code-snippet {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            font-family: monospace;
            margin: 15px 0;
        }
        .btn-back {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary btn-back">
            <i class="fas fa-arrow-left me-2"></i>Retour à l'accueil
        </a>
        
        <div class="header">
            <h1 class="text-primary"><i class="fas fa-stethoscope me-2"></i>Diagnostic de Paiement</h1>
            <p class="lead">Identifiez et résolvez les problèmes d'initiation de paiement</p>
        </div>

        <div class="status-card">
            <h4><i class="fas fa-info-circle me-2"></i>État du système</h4>
            <div id="system-status">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>Vérification de la connexion au serveur...</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>Vérification de l'authentification...</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>Vérification de l'endpoint de paiement...</div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-cogs me-2"></i>Configuration
                    </div>
                    <div class="card-body">
                        <h5>Paramètres actuels</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                URL de l'API
                                <span id="api-url">https://quiz-de-carabin-backend.onrender.com</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                URL du frontend
                                <span id="frontend-url">https://quiz-de-carabin.netlify.app</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Utilisateur connecté
                                <span id="user-status">Non connecté</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Token d'authentification
                                <span id="token-status">Non disponible</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-wrench me-2"></i>Actions
                    </div>
                    <div class="card-body text-center">
                        <button id="run-diagnostic" class="btn btn-primary mb-3 w-100">
                            <i class="fas fa-play-circle me-2"></i>Lancer le diagnostic
                        </button>
                        <button id="initiate-payment" class="btn btn-payment mb-3 w-100" disabled>
                            <i class="fas fa-credit-card me-2"></i>Initier le paiement
                        </button>
                        <button id="view-logs" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-list me-2"></i>Afficher les logs techniques
                        </button>
                        <button id="refresh-status" class="btn btn-outline-info mt-3 w-100">
                            <i class="fas fa-sync-alt me-2"></i>Actualiser le statut
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagnostic-result" id="diagnostic-result">
            <!-- Results will be shown here -->
        </div>

        <div class="log-container" id="log-container" style="display: none;">
            <div>[SYSTEM] Initialisation du diagnostic de paiement</div>
            <div>[CONFIG] API URL: https://quiz-de-carabin-backend.onrender.com</div>
            <div>[CONFIG] Frontend URL: https://quiz-de-carabin.netlify.app</div>
        </div>

        <div class="mt-4 p-3 bg-light rounded">
            <h5><i class="fas fa-lightbulb me-2"></i>Conseils de dépannage</h5>
            <ul>
                <li>Vérifiez que vous êtes bien connecté à votre compte</li>
                <li>Assurez-vous que votre connexion internet est stable</li>
                <li>Vérifiez que les URLs de l'API sont correctes</li>
                <li>Contactez le support si le problème persiste</li>
            </ul>
            
            <h5 class="mt-3"><i class="fas fa-code me-2"></i>Extrait de code pour payment.js</h5>
            <div class="code-snippet">
                <pre>async initiatePayment() {
    try {
        const token = window.auth.getToken();
        if (!token) {
            alert('Vous devez vous connecter pour souscrire à un abonnement.');
            return;
        }

        console.log('Initiation du paiement avec le token:', token);

        const response = await fetch(${CONFIG.API_BASE_URL}/api/payment/initiate, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': Bearer ${token}
            },
            body: JSON.stringify({
                callback_url: ${CONFIG.FRONTEND_URL}/payment-callback.html
            })
        });

        console.log('Réponse du serveur de paiement:', response);

        if (!response.ok) {
            throw new Error(Erreur HTTP: ${response.status});
        }

        const data = await response.json();
        console.log('Données de réponse:', data);

        if (data.success) {
            // Redirection vers PayDunya
            window.location.href = data.invoiceURL;
        } else {
            alert('Erreur lors de l\'initiation du paiement: ' + data.message);
        }
    } catch (error) {
        console.error('Error initiating payment:', error);
        alert('Erreur lors de l\'initiation du paiement: ' + error.message);
    }
}</pre>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const runDiagnosticBtn = document.getElementById('run-diagnostic');
            const initiatePaymentBtn = document.getElementById('initiate-payment');
            const viewLogsBtn = document.getElementById('view-logs');
            const refreshStatusBtn = document.getElementById('refresh-status');
            const logContainer = document.getElementById('log-container');
            const diagnosticResult = document.getElementById('diagnostic-result');
            const systemStatus = document.getElementById('system-status');
            
            // Mettre à jour le statut initial
            updateStatus();
            
            // Fonction pour mettre à jour le statut
            function updateStatus() {
                // Simuler la vérification de l'utilisateur connecté
                const user = JSON.parse(localStorage.getItem('quizUser') || 'null');
                const token = localStorage.getItem('quizToken');
                
                document.getElementById('user-status').textContent = user ? user.name : 'Non connecté';
                document.getElementById('token-status').textContent = token ? 'Disponible' : 'Non disponible';
                
                if (user && token) {
                    document.getElementById('user-status').className = 'text-success';
                    document.getElementById('token-status').className = 'text-success';
                } else {
                    document.getElementById('user-status').className = 'text-danger';
                    document.getElementById('token-status').className = 'text-danger';
                }
                
                addLog('Statut du système mis à jour');
            }
            
            // Ajouter un log
            function addLog(message) {
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // Exécuter le diagnostic
            runDiagnosticBtn.addEventListener('click', function() {
                addLog('Lancement du diagnostic...');
                diagnosticResult.style.display = 'block';
                diagnosticResult.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>Exécution des tests de diagnostic...
                    </div>
                `;
                
                // Simuler les tests de diagnostic
                setTimeout(() => {
                    diagnosticResult.innerHTML = `
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle me-2"></i>Diagnostic complet</h4>
                            <p>Le système a identifié les problèmes potentiels.</p>
                        </div>
                        <div class="mt-3">
                            <h5>Résultats du diagnostic:</h5>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Problème détecté:</strong> L'endpoint de paiement ne répond pas correctement.
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Solution recommandée:</strong> Vérifiez la configuration du serveur et les logs côté backend.
                            </div>
                        </div>
                    `;
                    
                    // Activer le bouton de paiement
                    initiatePaymentBtn.disabled = false;
                    addLog('Diagnostic terminé. Problème identifié: endpoint de paiement.');
                }, 2000);
            });
            
            // Initier le paiement
            initiatePaymentBtn.addEventListener('click', async function() {
                addLog('Tentative d initiation du paiement...');
                
                try {
                    // Simuler l'appel API
                    const response = await simulatePaymentRequest();
                    
                    if (response.success) {
                        addLog('Paiement initié avec succès! Redirection...');
                        diagnosticResult.innerHTML = `
                            <div class="alert alert-success">
                                <h4><i class="fas fa-check-circle me-2"></i>Paiement initié</h4>
                                <p>Vous allez être redirigé vers la plateforme de paiement.</p>
                            </div>
                        `;
                        
                        // Simuler une redirection
                        setTimeout(() => {
                            alert('Redirection vers la plateforme de paiement...');
                        }, 1500);
                    } else {
                        throw new Error(response.message || 'Erreur lors de l\'initiation du paiement');
                    }
                } catch (error) {
                    addLog(`ERREUR: ${error.message}`);
                    diagnosticResult.innerHTML = `
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-circle me-2"></i>Échec du paiement</h4>
                            <p>${error.message}</p>
                            <p class="mt-2">Veuillez vérifier votre connexion et réessayer.</p>
                        </div>
                    `;
                }
            });
            
            // Afficher/masquer les logs
            viewLogsBtn.addEventListener('click', function() {
                logContainer.style.display = logContainer.style.display === 'none' ? 'block' : 'none';
            });
            
            // Actualiser le statut
            refreshStatusBtn.addEventListener('click', function() {
                addLog('Actualisation du statut...');
                updateStatus();
            });
            
            // Fonction de simulation d'appel API de paiement
            async function simulatePaymentRequest() {
                addLog('Envoi de la requête à /api/payment/initiate');
                
                // Simuler un délai réseau
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Simuler une réponse d'erreur (à remplacer par un vrai appel API)
                const isSuccess = Math.random() > 0.5;
                
                if (isSuccess) {
                    return {
                        success: true,
                        invoiceURL: 'https://paydunya.com/checkout/abc123'
                    };
                } else {
                    return {
                        success: false,
                        message: 'Le service de paiement est temporairement indisponible'
                    };
                }
            }
        });
    </script>
</body>
</html>